<h1 id="wbgt_watcher">WBGT_watcher</h1>
<p>WBGT 計測ユニット</p>
<p>M5Stack と
I2C接続のI2Cユニットを組み合わせ、温湿度、気圧変化を測定し、暑さ指数と不快指数を
表示するシステムである。1分毎に表示を更新し、計測データは、シリアル通信でUSBケーブルを通じて、ホストに送出される。</p>
<p><img src="../images/SystemConfigurationDiagram.png"
style="width:50.0%" alt="システム構成図" /><br />
システム構成図</p>
<p><img src="../photo/DSCN0223_800x600.jpg"
alt="WBGT 計測ユニット" /><br />
WBGT 計測ユニット</p>
<h2 id="ハードウェア">ハードウェア</h2>
<ul>
<li>M5Stack社 <a href="https://docs.m5stack.com/ja/core/gray">M5Stack
gray</a></li>
<li>M5Stack社 <a
href="https://docs.m5stack.com/ja/unit/ENV%E2%85%A3%20Unit">ENV IV
Unit</a><br />
Temperature Humidity Air Pressure Sensor (SHT40+BMP280)</li>
</ul>
<p>M5Stackに、温湿度センサーユニットをI2Cケーブルで接続しただけのシンプルな構成である。</p>
<h2 id="ソフトウェア">ソフトウェア</h2>
<p>tinygoを使用して開発した。
液晶と温湿度センサーユニットを初期化後、1分毎に、液晶の表示を更新し、測定結果を
シリアル通信でUSBケーブルを通じて送出するだけのシンプルな構成である。</p>
<p>シリアルに出力するデータは、以下の順番で’,’区切りのテキストとして送出される。</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">温度,湿度,気圧,暑さ指数,不快指数</span></span></code></pre></div>
<h2 id="コンパイルと書き込み">コンパイルと書き込み</h2>
<p>以下のコマンドを実行すれば、コンパイル後、出来上がったプログラムは、直接、M5Stackに書き込まれる。</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">tinygo</span> flash  <span class="at">-target</span><span class="op">=</span>m5stack <span class="at">-size</span><span class="op">=</span>short <span class="at">-monitor</span> .</span></code></pre></div>
<p>もし、上手く書き込めない場合は、以下のコマンドを実行し、uf2ファイルを生成する。<br />
その後、出来上がったWBGT_watcher.uf2を手作業で、M5Stackに書き込めば良い。</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">tinygo</span> build <span class="at">-o</span> WBGT_watcher.uf2 <span class="at">-target</span><span class="op">=</span>m5stack <span class="at">-size</span><span class="op">=</span>short .</span></code></pre></div>
<h2 id="動作確認">動作確認</h2>
<p>flashで書き込みができた場合は、自動的にコンソールがモニターモードに切り替わる。<br />
そして、しばらくすると、以下のように、1分毎に1行づつ測定データが表示される。<br />
終了するには、Ctrl+Cを押す。</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">2025-08-08,08:30:15,27.14,67.06,989.02,23.84,76.72</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="ex">2025-08-08,08:31:15,27.10,67.26,989.02,23.82,76.67</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="ex">2025-08-08,08:32:16,27.11,67.35,989.02,23.84,76.71</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="ex">2025-08-08,08:33:16,27.15,67.33,989.02,23.88,76.76</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="ex">2025-08-08,08:34:16,27.19,67.32,988.99,23.92,76.82</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="ex">2025-08-08,08:35:15,27.20,67.18,989.02,23.91,76.81</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="ex">2025-08-08,08:36:15,27.23,67.05,989.04,23.92,76.84</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="ex">2025-08-08,08:37:15,27.23,66.85,989.05,23.90,76.81</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="ex">2025-08-08,08:38:16,27.21,66.76,989.08,23.87,76.77</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="ex">2025-08-08,08:39:16,27.20,66.75,989.07,23.86,76.77</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="ex">2025-08-08,08:40:16,27.19,66.74,989.09,23.85,76.74</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="ex">2025-08-08,08:41:15,27.16,66.61,989.08,23.81,76.69</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="ex">2025-08-08,08:42:15,27.16,66.51,989.09,23.80,76.67</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="ex">2025-08-08,08:43:15,27.16,66.43,989.08,23.79,76.67</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="ex">2025-08-08,08:44:16,27.16,66.43,989.09,23.79,76.66</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="ex">2025-08-08,08:45:16,27.14,66.33,989.08,23.76,76.62</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="ex">2025-08-08,08:46:15,27.15,66.16,989.12,23.75,76.62</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="ex">2025-08-08,08:47:15,27.17,66.11,989.13,23.77,76.64</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="ex">2025-08-08,08:48:15,27.18,65.99,989.17,23.76,76.64</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="ex">2025-08-08,08:49:16,27.19,65.85,989.20,23.76,76.63</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="ex">2025-08-08,08:50:16,27.17,65.74,989.22,23.73,76.60</span></span></code></pre></div>
<p>build
でuf2ファイルを生成し、手作業でM5Stackに書き込んだ場合は、以下のコマンドを実行し、
コンソールをモニターモードに切り替える。</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">tinygo</span> monitor</span></code></pre></div>
<p>しばらくすると、1分毎に、1行づつ測定データが表示される。<br />
終了するには、Ctrl+Cを押す。</p>
<h2 id="注意点">注意点</h2>
<h3 id="日本語の表示">日本語の表示</h3>
<p>開発当初は、英数字のみで液晶に表示を行っていたが、日本語を含む文字列が加わると、表示ができなくなった。<br />
現状では、tinygoは、内部に、英数字のフォントデータしか持っていないので、多バイト文字のフォントを表示することはできない。<br />
また、組込みの場合、巨大なフォントデータを埋め込んでおいても、そのごく一部しか使用されることがないので、不合理である。<br />
現状では、フォントファイルから、使用するフォントだけの情報を抜き出し、それを埋め込むことで、多バイト文字を表示している。<br />
日本語の表記を変更する場合は、tinygo本家に書かれている以下の多バイト文字の表示手順のサンプルを参考にすること。</p>
<p><a
href="https://github.com/tinygo-org/tinyfont/tree/release/examples/unicode_font3_const2bit">unicode_font3_const</a></p>
<h3 id="文字化け">文字化け</h3>
<p>液晶に”危険”と表示しようとしたが、“険”が正常に表示できなかった。<br />
いろいろと試行錯誤した結果、旧字体の”險”であれば、表示できることがわかった。<br />
新字体が表示できて、旧字体が表示できないのはありそうなことだが、その逆というのは、不思議なことだ。<br />
原因は不明であるが、当面は、“危險”という表記にしておく。<br />
他にも、表示できない文字があるのかもしれない。特に、旧字体が存在する文字コードは、鬼門なのかもしれない。</p>
<h3 id="フォントデータのサイズ">フォントデータのサイズ</h3>
<p>最初は、main.goのソースコードを直接参照してフォントデータを抽出していたが、データエリアが足りないというエラーがでて、コンパイルできなくなった。
これは、main.goに含まれる文字列定義がすべて抽出されたため、埋め込まれるフォントデータのサイズが大きくなりすぎて、コンパイルできなくなったようだ。</p>
<p>最初は、以下のように、オリジナルのソースコードから、直接、24ptと40ptのフォントデータを生成していたので、データサイズが大きくなった。</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">main.go</span> <span class="at">--</span><span class="op">&gt;</span> font24.go</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="ex">main.go</span> <span class="at">--</span><span class="op">&gt;</span> font40.go</span></code></pre></div>
<p>そこで、24ptと40ptのフォントを使う文字列をそれぞれ別ファイルで定義し、それをmain.goから参照するコードに書き換えた。
そして、別ファイルになった文字列の定義ファイルから、それぞれのフォントデータを生成する方法に切り替えた。
こうすることで、必要最低限の文字コードのデータしか抽出されないので、フォントデータが小さくなり、コンパイルできるようになった。</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">main.go</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">jp-40pt_string.go</span> <span class="at">--</span><span class="op">&gt;</span> jp_font40.go</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="ex">jp-24pt_string.go</span> <span class="at">--</span><span class="op">&gt;</span> jp_font24.go</span></code></pre></div>
